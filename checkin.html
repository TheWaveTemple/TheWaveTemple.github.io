<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guest Check-In System</title>
 <style>
    :root {
      --primary: #6CC9C3;
      --primary-dark: #5BB5AF;
      --secondary: #64748b;
      --light: #f8fafc;
      --dark: #0f172a;
      --border: #cbd5e1;
      --success: #10b981;
      --error: #ef4444;
      --radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #f1f5f9, #e2e8f0); color: var(--dark); padding: 20px; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    
    .hidden { display: none !important; }

    .header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); }
    .header h1 { color: var(--primary); margin-bottom: 10px; }
    .form-container { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 30px; }
    .form-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--primary); color: white; }
    #lang-switcher { padding: 8px 12px; border-radius: var(--radius); border: none; background: white; cursor: pointer; font-weight: bold; }
    
    form { padding: 20px; }
    .form-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
    .form-section h3 { margin-bottom: 15px; color: var(--primary); font-size: 1.2rem; display: flex; align-items: center; }
    .form-section h3 i { margin-right: 10px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .full-width { grid-column: 1 / -1; }
    label { margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
    input, select { padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; }
    
    .signature-container { border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; background: #fcfcfc; }
    #signature-pad { width: 100%; height: 150px; border: 1px solid var(--border); border-radius: var(--radius); background: #ffffff; touch-action: none; cursor: crosshair; }
    
    .btn-primary { background: var(--primary); color: white; border: none; padding: 15px 24px; border-radius: var(--radius); cursor: pointer; font-weight: 600; width: 100%; font-size: 1.1rem; }
    .btn-primary:disabled { background: var(--secondary); opacity: 0.7; cursor: not-allowed; }
    
    .spinner { 
        width: 24px; height: 24px; 
        border: 3px solid rgba(255,255,255,0.3); 
        border-top: 3px solid white; 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
        display: inline-block; 
        vertical-align: middle; 
        margin-left: 10px;
    }
    
    .uppercase { text-transform: uppercase; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://static.wixstatic.com/media/91a755_ebad918f50374773afafffd4990151d4~mv2.png/v1/crop/x_0,y_28,w_1322,h_325/fill/w_470,h_116,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_pinzell_hor_Mesa%20de%20trabajo%201.png" alt="Hotel Logo">
    </div>
    
    <div class="form-container">
      <div class="form-header">
        <h2><i class="fas fa-user-check"></i> <span data-i18n="regTitle">Registration</span></h2>
        <select id="lang-switcher">
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
        </select>
      </div>
      
      <form id="checkin-form">
        <input type="hidden" name="contractDate" id="contractDate">

        <div class="form-section">
          <h3><i class="fas fa-user-circle"></i> <span data-i18n="personalInfo">Personal Information</span></h3>
          <div class="form-grid">
            <div class="form-group"><label data-i18n="fullName">Name</label><input type="text" name="name" required class="uppercase"></div>
            <div class="form-group"><label data-i18n="surname">First Surname</label><input type="text" name="surname1" required class="uppercase"></div>
            <div class="form-group"><label data-i18n="secondSurname">Second Surname</label><input type="text" name="surname2" class="uppercase"></div>
            <div class="form-group">
              <label data-i18n="nationality">Nationality</label>
              <input type="text" name="nationality" list="iso-countries" placeholder="ESP" pattern="[A-Z]{3}" maxlength="3" required class="uppercase">
            </div>
            <div class="form-group"><label data-i18n="dob">Date of Birth</label><input type="date" name="dob" required></div>
            <div class="form-group">
              <label data-i18n="gender">Gender</label>
              <select name="gender" required>
                <option value="" data-i18n="select">Select...</option>
                <option value="H" data-i18n="male">Male</option>
                <option value="M" data-i18n="female">Female</option>
                <option value="O" data-i18n="other">Other</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-id-card"></i> <span data-i18n="docTitle">Documentation</span></h3>
          <div class="form-grid">
            <div class="form-group">
              <label data-i18n="documentType">Type</label>
              <select name="documentType" id="docTypeSelect" onchange="toggleSupportField()" required>
                <option value="" data-i18n="select">Select...</option>
                <option value="NIF">DNI (Spain)</option>
                <option value="NIE">NIE (Spain)</option>
                <option value="PAS">Passport</option>
                <option value="OTRO" data-i18n="otherDoc">Other</option>
              </select>
            </div>
            <div class="form-group"><label data-i18n="documentId">Number</label><input type="text" name="document" required class="uppercase"></div>
            <div class="form-group hidden" id="support-group">
              <label style="color:var(--primary-dark)" data-i18n="supportNumber">Support Number (9 chars)</label>
              <input type="text" name="supportNumber" id="supportNumber" maxlength="9" pattern=".{9}" class="uppercase">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-home"></i> <span data-i18n="addressInfo">Address</span></h3>
          <div class="form-grid">
            <div class="form-group full-width"><label data-i18n="address">Address</label><input type="text" name="address" required></div>
            <div class="form-group"><label data-i18n="city">City</label><input type="text" name="city" required></div>
            <div class="form-group"><label data-i18n="postalCode">Postal Code</label><input type="text" name="postalCode" required></div>
            <div class="form-group">
              <label data-i18n="country">Country (ISO 3)</label>
              <input type="text" name="country" list="iso-countries" placeholder="ESP" pattern="[A-Z]{3}" maxlength="3" required class="uppercase">
            </div>
            <div class="form-group"><label data-i18n="email">Email</label><input type="email" name="email" required></div>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-credit-card"></i> <span data-i18n="stayInfo">Stay & Payment</span></h3>
          <div class="form-grid">
            <div class="form-group"><label data-i18n="checkinDate">Check-in</label><input type="date" name="checkinDate" id="checkinDate" required></div>
            <div class="form-group"><label data-i18n="checkoutDate">Check-out</label><input type="date" name="checkoutDate" id="checkoutDate" required></div>
            <div class="form-group">
                <label data-i18n="paymentType">Payment</label>
                <select name="paymentType" required>
                    <option value="PLATF" data-i18n="payPlatform">Platform</option>
                    <option value="TARJT" data-i18n="payCard">Card</option>
                    <option value="EFECT" data-i18n="payCash">Cash</option>
                </select>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h3><i class="fas fa-pen-nib"></i> <span data-i18n="signature">Signature</span></h3>
          <div class="signature-container">
            <canvas id="signature-pad"></canvas>
            <div style="text-align:right; margin-top:10px;">
              <button type="button" onclick="clearSignature()" data-i18n="clear" style="padding:5px 10px; cursor:pointer;">Clear</button>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary" id="submit-btn">
          <span id="btn-text" data-i18n="submit">Submit Registration</span>
          <div id="btn-spinner" class="spinner hidden"></div>
        </button>
      </form>
    </div>
  </div>

  <datalist id="iso-countries"></datalist>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- LISTA DE PAÍSES (INCLUIDO PALESTINA PSE) ---
    const countryList = {
        "AFG":"Afghanistan", "ALB":"Albania", "DZA":"Algeria", "AND":"Andorra", "AGO":"Angola", "ARG":"Argentina", "ARM":"Armenia", "AUS":"Australia", "AUT":"Austria", "AZE":"Azerbaijan",
        "BEL":"Belgium", "BEN":"Benin", "BOL":"Bolivia", "BRA":"Brazil", "BGR":"Bulgaria", "CAN":"Canada", "CHL":"Chile", "CHN":"China", "COL":"Colombia", "CRI":"Costa Rica", "HRV":"Croatia",
        "CUB":"Cuba", "CYP":"Cyprus", "CZE":"Czech Republic", "DNK":"Denmark", "DOM":"Dominican Republic", "ECU":"Ecuador", "EGY":"Egypt", "SLV":"El Salvador", "EST":"Estonia", "FIN":"Finland",
        "FRA":"France", "GEO":"Georgia", "DEU":"Germany", "GRC":"Greece", "GTM":"Guatemala", "HND":"Honduras", "HUN":"Hungary", "ISL":"Iceland", "IND":"India", "IDN":"Indonesia", "IRL":"Ireland",
        "ISR":"Israel", "ITA":"Italy", "JAM":"Jamaica", "JPN":"Japan", "JOR":"Jordan", "KAZ":"Kazakhstan", "KEN":"Kenya", "KOR":"South Korea", "KWT":"Kuwait", "LVA":"Latvia", "LTU":"Lithuania",
        "LUX":"Luxembourg", "MEX":"Mexico", "MCO":"Monaco", "MAR":"Morocco", "NLD":"Netherlands", "NZL":"New Zealand", "NIC":"Nicaragua", "NOR":"Norway", "PAN":"Panama", "PRY":"Paraguay",
        "PER":"Peru", "PHL":"Philippines", "POL":"Poland", "PRT":"Portugal", "PSE":"Palestine", "ROU":"Romania", "RUS":"Russia", "SAU":"Saudi Arabia", "SEN":"Senegal", "SRB":"Serbia", "SGP":"Singapore",
        "SVK":"Slovakia", "SVN":"Slovenia", "ZAF":"South Africa", "ESP":"Spain", "SWE":"Sweden", "CHE":"Switzerland", "THA":"Thailand", "TUN":"Tunisia", "TUR":"Turkey", "UKR":"Ukraine",
        "ARE":"United Arab Emirates", "GBR":"United Kingdom", "USA":"United States", "URY":"Uruguay", "VEN":"Venezuela", "VNM":"Vietnam"
    };

    const datalist = document.getElementById('iso-countries');
    Object.entries(countryList).forEach(([code, name]) => {
        const opt = document.createElement('option');
        opt.value = code; opt.textContent = name;
        datalist.appendChild(opt);
    });

    // --- TRADUCCIONES (4 IDIOMAS) ---
    const translations = {
      en: {
        headerSubtitle: "Registration for SES Hospedajes", regTitle: "Registration", personalInfo: "Personal Details",
        fullName: "Name", surname: "1st Surname", secondSurname: "2nd Surname", nationality: "Nationality (ISO 3)",
        dob: "Birth Date", gender: "Gender", select: "Select...", male: "Male", female: "Female", other: "Other",
        docTitle: "ID Document", documentType: "Type", otherDoc: "Other ID", documentId: "Number",
        supportNumber: "Support No. (9 chars)", addressInfo: "Address", address: "Street", city: "City",
        postalCode: "Postcode", country: "Country (ISO 3)", email: "Email", stayInfo: "Stay & Payment",
        checkinDate: "Arrival", checkoutDate: "Departure", paymentType: "Payment", payPlatform: "Booking/Airbnb/Online",
        payCard: "Card", payCash: "Cash", signature: "Signature", clear: "Clear", submit: "Submit"
      },
      es: {
        headerSubtitle: "Registro legal para SES Hospedajes", regTitle: "Registro", personalInfo: "Datos Personales",
        fullName: "Nombre", surname: "1er Apellido", secondSurname: "2do Apellido", nationality: "Nacionalidad (ISO 3)",
        dob: "Fecha Nacimiento", gender: "Género", select: "Seleccionar...", male: "Hombre", female: "Mujer", other: "Otro",
        docTitle: "Documentación", documentType: "Tipo", otherDoc: "Otro Documento", documentId: "Número",
        supportNumber: "Nº Soporte (9 car.)", addressInfo: "Dirección", address: "Calle", city: "Ciudad",
        postalCode: "Código Postal", country: "País (ISO 3)", email: "Email", stayInfo: "Estancia y Pago",
        checkinDate: "Entrada", checkoutDate: "Salida", paymentType: "Pago", payPlatform: "Booking/Airbnb/Online",
        payCard: "Tarjeta", payCash: "Efectivo", signature: "Firma", clear: "Borrar", submit: "Enviar"
      },
      fr: {
        headerSubtitle: "Enregistrement SES Hospedajes", regTitle: "Enregistrement", personalInfo: "Infos Personnelles",
        fullName: "Prénom", surname: "Nom", secondSurname: "Deuxième Nom", nationality: "Nationalité (ISO 3)",
        dob: "Date Naissance", gender: "Genre", select: "Sélectionner...", male: "Homme", female: "Femme", other: "Autre",
        docTitle: "Pièce d'identité", documentType: "Type", otherDoc: "Autre ID", documentId: "Numéro",
        supportNumber: "Nº Support (9 car.)", addressInfo: "Adresse", address: "Rue", city: "Ville",
        postalCode: "Code Postal", country: "Pays (ISO 3)", email: "E-mail", stayInfo: "Séjour et Paiement",
        checkinDate: "Arrivée", checkoutDate: "Départ", paymentType: "Paiement", payPlatform: "Booking/Airbnb/Online",
        payCard: "Carte", payCash: "Espèces", signature: "Signature", clear: "Effacer", submit: "Envoyer"
      },
      de: {
        headerSubtitle: "Registrierung SES Hospedajes", regTitle: "Anmeldung", personalInfo: "Persönliche Daten",
        fullName: "Vorname", surname: "Nachname", secondSurname: "Zweiter Nachname", nationality: "Nationalität (ISO 3)",
        dob: "Geburtsdatum", gender: "Geschlecht", select: "Wählen...", male: "Männlich", female: "Weiblich", other: "Andere",
        docTitle: "Ausweisdokument", documentType: "Typ", otherDoc: "Anderes Dokument", documentId: "Nummer",
        supportNumber: "Support-Nr. (9 Zeichen)", addressInfo: "Adresse", address: "Straße", city: "Stadt",
        postalCode: "Postleitzahl", country: "Land (ISO 3)", email: "E-Mail", stayInfo: "Aufenthalt & Zahlung",
        checkinDate: "Anreise", checkoutDate: "Abreise", paymentType: "Zahlungsart", payPlatform: "Booking/Airbnb/Online",
        payCard: "Karte", payCash: "Barzahlung", signature: "Unterschrift", clear: "Löschen", submit: "Absenden"
      }
    };

    function applyTranslations(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (translations[lang][key]) el.textContent = translations[lang][key];
      });
    }
    document.getElementById("lang-switcher").addEventListener("change", e => applyTranslations(e.target.value));
    applyTranslations("en");

    // --- ASIGNAR FECHA DE CONTRATO AL CARGAR ---
    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('contractDate').value = today;
    });

    // --- LÓGICA FORMULARIO ---
    function toggleSupportField() {
      const type = document.getElementById('docTypeSelect').value;
      const group = document.getElementById('support-group');
      const input = document.getElementById('supportNumber');
      if (type === 'NIF' || type === 'NIE') {
        group.classList.remove('hidden'); input.required = true;
      } else {
        group.classList.add('hidden'); input.required = false; input.value = '';
      }
    }

    document.querySelectorAll('.uppercase').forEach(input => {
        input.addEventListener('input', () => input.value = input.value.toUpperCase());
    });

    // --- FIRMA ---
    const canvas = document.getElementById('signature-pad');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    const resize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; clearSignature(); };
    window.addEventListener('resize', resize); resize();
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
    };
    canvas.addEventListener('mousedown', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); });
    window.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchmove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); });
    window.addEventListener('touchend', () => drawing = false);
    function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = "#000"; ctx.lineWidth = 2; }

    // --- ENVÍO ---
    document.getElementById('checkin-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const text = document.getElementById('btn-text');
      const spin = document.getElementById('btn-spinner');
      
      btn.disabled = true; spin.classList.remove('hidden'); text.style.opacity = "0.5";

      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // PDF GENERATION
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("GUEST REGISTRATION FORM", 20, 20);
        doc.setFontSize(10);
        doc.text(`Contract Date: ${data.contractDate}`, 20, 30); // Incluido en PDF
        doc.text(`Guest: ${data.name} ${data.surname1}`, 20, 40);
        doc.text(`ID: ${data.documentType} - ${data.document}`, 20, 47);
        doc.text(`Stay: ${data.checkinDate} to ${data.checkoutDate}`, 20, 54);
        doc.addImage(canvas.toDataURL(), 'PNG', 20, 65, 60, 30);
        
        const base64Pdf = doc.output('datauristring').split(',')[1];

        const resp = await fetch("https://script.google.com/macros/s/AKfycbwmnSIcC_Lx5LBbh-Z8VPdsLnhe-a6c2HXr9eNBDFNScEs5EyRQyLx4svxjPn61UKj7YA/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ ...data, filename: `CheckIn_${data.surname1}.pdf`, mimeType: "application/pdf", data: base64Pdf })
        });

        const resultText = await resp.text();
        if(resultText.includes("Success")) { alert("Submitted successfully!"); location.reload(); }
        else { alert("Server Error: " + resultText); }
      } catch (err) { alert("Network Error: " + err.message); }
      finally { btn.disabled = false; spin.classList.add('hidden'); text.style.opacity = "1"; }
    });
  </script>
</body>
</html>
